/*
 * Copyright (c) 2019. Antonello Andrea (www.hydrologis.com). All rights reserved.
 * Use of this source code is governed by a GPL3 license that can be
 * found in the LICENSE file.
 */
import 'package:sqflite/sqflite.dart';

String NOTES_TABLE = "notes";
/*
 * id of the note, Generated by the db.
 */
String COLUMN_ID = "_id";
/*
 * Longitude of the note in WGS84.
 */
String COLUMN_LON = "lon";
/*
 * Latitude of the note in WGS84.
 */
String COLUMN_LAT = "lat";
/*
 * Elevation of the note.
 */
String COLUMN_ALTIM = "altim";
/*
 * Timestamp of the note.
 */
String COLUMN_TS = "ts";
/*
 * Description of the note.
 */
String COLUMN_DESCRIPTION = "description";
/*
 * Simple text of the note.
 */
String COLUMN_TEXT = "text";
/*
 * Form data of the note.
 */
String COLUMN_FORM = "form";
/*
 * Is dirty field =0 = false, 1 = true)
 */
String COLUMN_ISDIRTY = "isdirty";
/*
 * Style of the note.
 */
String COLUMN_STYLE = "style";

class Note {
  int id;
  String text;
  String description;
  int timeStamp;
  double lon;
  double lat;
  double altim;
  String style;
  String form;
  int isDirty = 1;

  Map<String, dynamic> toMap() {
    var map = {
      COLUMN_LAT: lat,
      COLUMN_LON: lon,
      COLUMN_TS: timeStamp,
      COLUMN_TEXT: text,
      COLUMN_ISDIRTY: isDirty,
    };
    if (id != null) {
      map[COLUMN_ID] = id;
    }
    if (form != null) {
      map[COLUMN_FORM] = form;
    }
    if (altim != null) {
      map[COLUMN_ALTIM] = altim;
    }
    if (description != null) {
      map[COLUMN_DESCRIPTION] = description;
    }
    if (style != null) {
      map[COLUMN_STYLE] = style;
    }
    return map;
  }
}

/// Get the count of the current notes
///
/// Get the count on a given [db], using [onlyDirty] to count only dirty notes.
Future<int> getNotesCount(Database db, bool onlyDirty) async {
  String where = !onlyDirty ? "" : " where ${COLUMN_ISDIRTY} = 1";
  List<Map<String, dynamic>> resNotes = await db
      .rawQuery("SELECT count(*) as count FROM ${NOTES_TABLE} ${where}");

  var resNote = resNotes[0];
  var count = resNote["count"];
  return count;
}

/*
 * Add a note.
 *
 * @param db the database.
 * @param note the note to insert.
 * @return the inserted note id.
 */
Future<int> addNote(Database db, Note note) {
  var noteId = db.insert(NOTES_TABLE, note.toMap());
  return noteId;
}

//queryNotes(Database db) async {
//  // NOTES
//  List<Map<String, dynamic>> resNotes =
//      await db.query("notes", columns: ['lat', 'lon', 'text', 'form']);
//  resNotes.forEach((map) {
//    var lat = map["lat"];
//    var lon = map["lon"];
//    var text = map["text"];
//    var label = "note: ${text}\nlat: ${lat}\nlon: ${lon}";
//  });
//}
